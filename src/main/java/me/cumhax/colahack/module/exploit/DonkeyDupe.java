package me.cumhax.colahack.module.exploit;

import java.util.Comparator;
import me.cumhax.colahack.util.LoggerUtil;
import me.cumhax.colahack.module.*;
import net.minecraft.block.Block;
import net.minecraft.block.BlockChest;
import net.minecraft.entity.Entity;
import net.minecraft.entity.passive.AbstractChestHorse;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.init.Items;
import net.minecraft.item.ItemBlock;
import net.minecraft.item.ItemStack;
import net.minecraft.util.EnumHand;

public class DonkeyDupe
extends Module {
    Entity donkey;

    public DonkeyDupe() {
        super("DonkeyDupe", "Donkey Dupe", Category.EXPLOIT);
    }

    public boolean setup() {
        return false;
    }

    @Override
    public void onEnable() {
        if (this.findAirInHotbar() == -1) {
            this.disable();
            return;
        }
        if (this.findChestInHotbar() == -1) {
            this.disable();
            return;
        }
        this.donkey = DonkeyDupe.mc.world.loadedEntityList.stream().filter(this::isValidEntity).min(Comparator.comparing(p_Entity -> Float.valueOf(DonkeyDupe.mc.player.getDistance(p_Entity)))).orElse(null);
        if (this.donkey == null) {
            this.disable();
            return;
        }
    }

    @Override
    public void onUpdate() {
        if (this.findAirInHotbar() == -1) {
            this.disable();
            return;
        }
        if (this.findChestInHotbar() == -1) {
            this.disable();
            return;
        }
        this.donkey = DonkeyDupe.mc.world.loadedEntityList.stream().filter(this::isValidEntity).min(Comparator.comparing(p_Entity -> Float.valueOf(DonkeyDupe.mc.player.getDistance(p_Entity)))).orElse(null);
        if (this.donkey == null) {
            this.disable();
            return;
        }
        this.putChestOn();
        LoggerUtil.sendMessage("put chest on the donkey");
        this.toggle();
    }

    public void putChestOn() {
        DonkeyDupe.mc.player.inventory.currentItem = this.findAirInHotbar();
        DonkeyDupe.mc.player.inventory.currentItem = this.findChestInHotbar();
        DonkeyDupe.mc.playerController.interactWithEntity((EntityPlayer)DonkeyDupe.mc.player, this.donkey, EnumHand.MAIN_HAND);
    }

    private int findChestInHotbar() {
        int slot = -1;
        for (int i = 0; i < 9; ++i) {
            Block block;
            ItemStack stack = DonkeyDupe.mc.player.inventory.getStackInSlot(i);
            if (stack == ItemStack.EMPTY || !(stack.getItem() instanceof ItemBlock) || !((block = ((ItemBlock)stack.getItem()).getBlock()) instanceof BlockChest)) continue;
            slot = i;
            break;
        }
        return slot;
    }

    private int findAirInHotbar() {
        int slot = -1;
        for (int i = 0; i < 9; ++i) {
            ItemStack stack = DonkeyDupe.mc.player.inventory.getStackInSlot(i);
            if (stack.getItem() != Items.AIR) continue;
            slot = i;
        }
        return slot;
    }

    private boolean isValidEntity(Entity entity) {
        if (entity instanceof AbstractChestHorse) {
            AbstractChestHorse donkey = (AbstractChestHorse)entity;
            return !donkey.isChild() && donkey.isTame();
        }
        return false;
    }
}
